---
AWSTemplateFormatVersion: "2010-09-09"
Description: "Create Generic EC2"
Parameters:
  VPCID:
    Description: "VPC from Generic VPC Stack"
    Type: String

  PublicSubnet1:
    Description: "Subnet From Generic VPC Stack"
    Type: String

  PublicSubnet2:
    Description: "Subnet From Generic VPC Stack"
    Type: String

  SecurityGroup:
    Description: "SecurityGroup From Generic VPC Stack"
    Type: String

Mappings:
  Name:
    Instance:
      "Instance": "webserver-1"

Resources:
  EC2InstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: '/'
      Roles:
      - !Ref EC2InstanceIAMRole
  EC2InstanceIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - 'ec2.amazonaws.com'
          Action:
          - 'sts:AssumeRole'
      Path: '/'
      ManagedPolicyArns:
      - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforAWSCodeDeploy'
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      IamInstanceProfile: !Ref EC2InstanceProfile
      InstanceType: t2.micro
      ImageId: "ami-0dba2cb6798deb6d8"
      KeyName: "eskool-infra-key"
      SecurityGroupIds:
        - !Ref SecurityGroup
      SubnetId: !Ref PublicSubnet1 
      Monitoring: true
      BlockDeviceMappings:
      - DeviceName: "/dev/sda1"
        Ebs:
          VolumeSize: 10
          VolumeType: gp2
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          apt-get update
          apt-get install -y auditd wget vim zip ruby unzip unrar rsync debconf-utils
          apt-get update
          wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install && chmod +x ./install && ./install auto && service codedeploy-agent start
      Tags:
      - Key: "Name"
        Value: !FindInMap [Name, Instance, Instance]
      - Key: DeploymentGroup
        Value: !Ref AWS::StackName

Outputs:
  EC2Instance1InstanceID:
    Description: The Instance ID
    Value: !Ref EC2Instance
  EC2Instance1PublicIp:
    Description: The Instance Public IP
    Value: !GetAtt EC2Instance.PublicIp